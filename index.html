<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>‡πÄ‡∏ä‡πá‡∏Ñ‡∏™‡∏ï‡πá‡∏≠‡∏Å‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</title>

<meta name="theme-color" content="#2563eb">
<link rel="manifest" href="manifest.json">
<link rel="icon" sizes="192x192" href="icon-192.png">
<link rel="apple-touch-icon" sizes="512x512" href="icon-512.png">

<style>
body{margin:0;font-family:system-ui,sans-serif;background:#f3f4f6;color:#111;padding-bottom:100px}
header{background:#111827;color:#fff;padding:20px;text-align:center}
.title{font-size:24px;font-weight:700}
.date{font-size:18px;opacity:.9;margin-top:4px}
.wrap{max-width:680px;margin:auto;padding:14px}
.card{background:#fff;border-radius:20px;padding:10px;margin-bottom:10px;box-shadow:0 8px 20px rgba(0,0,0,.08)}
.name{font-size:18px;font-weight:600;margin-bottom:10px}
.opts{display:grid;grid-template-columns:0.6fr 0.6fr 1fr;gap:6px}
.opt{border:2px solid #d1d5db;border-radius:16px;padding:10px 4px;text-align:center;font-size:16px;font-weight:400;transition:.15s}
.opt:active{transform:scale(.95)}
input{display:none}
input:checked + .opt.ok{background:#ecfdf5;border-color:#10b981;color:#047857}
input:checked + .opt.mid{background:#fff7ed;border-color:#fb923c;color:#9a3412}
input:checked + .opt.low{background:#fef2f2;border-color:#ef4444;color:#991b1b}
.fab{position:fixed;left:50%;bottom:20px;transform:translateX(-50%);width:calc(100% - 40px);max-width:720px;background:#2563eb;color:#fff;border:none;border-radius:26px;padding:26px;font-size:22px;font-weight:800;box-shadow:0 12px 26px rgba(37,99,235,.45)}
.fab:active{transform:translateX(-50%) scale(.96)}
.buy-box{background:#fff7ed;border:3px dashed #fb923c;border-radius:20px;padding:20px;margin-top:20px}
.buy-title{font-weight:900;font-size:22px;margin-bottom:6px}
.buy-date{font-size:16px;opacity:.8;margin-bottom:10px}
.buy-item{font-size:20px;margin-left:10px;margin-bottom:6px}
.loading{position:fixed;inset:0;background:rgba(0,0,0,.5);display:none;align-items:center;justify-content:center;z-index:99}
.spinner{width:64px;height:64px;border:6px solid #ddd;border-top-color:#2563eb;border-radius:50%;animation:spin 1s linear infinite}
@keyframes spin{to{transform:rotate(360deg)}}
.report-btn{
  position:fixed;
  top:16px;
  right:16px;
  width:44px;
  height:44px;
  border-radius:50%;
  border:none;
  background:#2563eb;
  color:#fff;
  font-size:20px;
  box-shadow:0 6px 16px rgba(0,0,0,.25);
  z-index:50;
}
.report-btn:active{transform:scale(.9)}
.report-modal{
  position:fixed;
  inset:0;
  background:rgba(0,0,0,.5);
  display:none;
  align-items:center;
  justify-content:center;
  z-index:100;
}
.report-box{
  background:#fff;
  width:90%;
  max-width:420px;
  border-radius:20px;
  padding:20px;
}
.report-title{
  font-size:20px;
  font-weight:800;
  margin-bottom:10px;
}
.report-box input{
  width:100%;
  padding:10px;
  font-size:16px;
  margin-bottom:12px;
}
.report-result{
  max-height:260px;
  overflow:auto;
  margin-bottom:12px;
}
.report-item{
  padding:8px 0;
  border-bottom:1px dashed #ddd;
}
.close-btn{
  width:100%;
  padding:12px;
  font-size:18px;
  border:none;
  border-radius:14px;
  background:#111827;
  color:#fff;
}

</style>
</head>
<body>
<header>
  <div class="title">‡πÄ‡∏ä‡πá‡∏Ñ‡∏™‡∏ï‡πá‡∏≠‡∏Å‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</div>
  <div class="date" id="today"></div>
</header>
<button class="report-btn" onclick="openReport()">üìä</button>

<div class="wrap" id="list"></div>
<div class="wrap" id="buy"></div>
<button class="fab" onclick="save()">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÅ‡∏•‡∏∞‡∏™‡∏£‡∏∏‡∏õ</button>

<div class="loading" id="loading"><div class="spinner"></div></div>
<script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>

<script>
const API = 'https://script.google.com/macros/s/AKfycbyV6wZDcVU7szOXuuQNj21rjn7-dvQ8JNqwQXaaMS8NvfD5DG2kIpyOjwfPbaHLUf9SLw/exec';
let stockData=[];
let todayText='';

(()=>{
  const d=new Date();
  todayText=d.toLocaleDateString('th-TH',{weekday:'long',year:'numeric',month:'long',day:'numeric'});
  document.getElementById('today').textContent=todayText;
})();

fetch(API+'?action=getStock')
.then(r=>r.json())
.then(data=>{
  stockData=data;
  const div=document.getElementById('list');
  data.forEach(i=>{
    div.innerHTML+=`
    <div class="card">
      <div class="name">${i.name}</div>
      <div class="opts">
        <label><input type="radio" name="${i.id}" value="‡∏°‡∏µ‡πÄ‡∏¢‡∏≠‡∏∞" checked><div class="opt ok">‡∏°‡∏µ‡πÄ‡∏¢‡∏≠‡∏∞</div></label>
        <label><input type="radio" name="${i.id}" value="‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡∏Ñ‡∏£‡∏∂‡πà‡∏á‡πÄ‡∏î‡∏µ‡∏¢‡∏ß"><div class="opt mid">‡∏Ñ‡∏£‡∏∂‡πà‡∏á‡πÄ‡∏î‡∏µ‡∏¢‡∏ß</div></label>
        <label><input type="radio" name="${i.id}" value="‡∏´‡∏°‡∏î‡πÅ‡∏•‡πâ‡∏ß‡∏´‡∏£‡∏∑‡∏≠‡πÉ‡∏Å‡∏•‡πâ‡∏´‡∏°‡∏î"><div class="opt low">‡πÉ‡∏Å‡∏•‡πâ‡∏´‡∏°‡∏î/‡∏´‡∏°‡∏î</div></label>
      </div>
    </div>`;
  });
});

function save(){
  document.getElementById('loading').style.display='flex';
  const result=stockData.map(i=>({
    id:i.id,
    name:i.name,
    status:document.querySelector(`input[name="${i.id}"]:checked`).value
  }));

  fetch(API,{method:'POST',body:JSON.stringify(result)})
  .then(r=>r.json())
  .then(showBuy);
}

function showBuy(list){
  document.getElementById('loading').style.display='none';
  const box=document.getElementById('buy');
  if(list.length===0){
    box.innerHTML=`<div class="buy-box"><div class="buy-title">‡∏™‡∏ï‡πá‡∏≠‡∏Å‡∏¢‡∏±‡∏á‡πÇ‡∏≠‡πÄ‡∏Ñ</div><div class="buy-date">${todayText}</div></div>`;
    return;
  }
  let html=`<div class="buy-box"><div class="buy-title">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏ã‡∏∑‡πâ‡∏≠</div><div class="buy-date">${todayText}</div>`;
  list.forEach(i=>html+=`<div class="buy-item">‚Ä¢ ${i.name}</div>`);
  html+='</div>';
  box.innerHTML=html;
html2canvas(document.querySelector('.buy-box')).then(canvas=>{
  const link = document.createElement('a');
  link.download = `‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏ã‡∏∑‡πâ‡∏≠_${new Date().toISOString().slice(0,10)}.png`;
  link.href = canvas.toDataURL('image/png');
  link.click();
});

}


function closeReport(){
  document.getElementById('reportModal').style.display='none';
}

function openReport(){
  document.getElementById('reportModal').style.display='flex';

  const input = document.getElementById('reportDate');
  input.value = '';

  input.onchange = e => {
    const date = e.target.value;
    if(!date) return;

    document.getElementById('reportResult').innerHTML = '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...';

    fetch(API+'?action=report&date='+date)
      .then(r=>r.json())
      .then(showReport);
  };
}


function showReport(list){
  const box=document.getElementById('reportResult');
  if(list.length===0){
    box.innerHTML='<div class="report-item">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</div>';
    return;
  }
  box.innerHTML='';
  list.forEach(i=>{
    box.innerHTML+=`<div class="report-item">‚Ä¢ ${i.name}</div>`;
  });
}

</script>
<div class="report-modal" id="reportModal">
  <div class="report-box">
    <div class="report-title">üìÖ ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏ã‡∏∑‡πâ‡∏≠‡∏¢‡πâ‡∏≠‡∏ô‡∏´‡∏•‡∏±‡∏á</div>

    <input type="date" id="reportDate">

    <div id="reportResult" class="report-result"></div>

    <button class="close-btn" onclick="closeReport()">‡∏õ‡∏¥‡∏î</button>
  </div>
</div>

</body>
</html>
